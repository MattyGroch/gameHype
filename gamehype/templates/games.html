{% extends "base.html" %}

{% block scripts %}
  {{ super() }}
<script src="{{ url_for('static', filename='js/jquery-bar-rating-master/jquery.barrating.js') }}"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
{% for g in games %}
<script type="text/javascript">
   $(function() {
      $('#{{ g.id }}').barrating({
        initialRating: '{% if g.latest_user_rating(user) == -1 %}0{% else %}{{ g.latest_user_rating(user) }}{% endif %}',
        theme: 'fontawesome-stars',
        showSelectedRating: true,
        allowEmpty: true,
        deselectable: true,
        emptyValue: '0',
        triggerChange: true,
        onSelect: function(value, text, event) {
          if (typeof(event) !== 'undefined') {
            axios.post('/change_hype_level', {
              user_id: '{{ user.id }}',
              game_id: '{{ g.id }}',
              rating: value
            })
            .then(function (response) {
              console.log(response);
            })
            .catch(function (error) {
              console.log(error);
            });
          } else {
            // value was set programatically
          }
        }
      });
   });
</script>
{% endfor %}
{% endblock scripts %}

{% block app_content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-5">
      <p>
        <h1 class="display-4">Game List</h1>
      </p>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <table class="table table-striped table-hover table-sm" id="gamehype_table">
        <thead class="thead-dark">
          <tr>
            <th scope="col">Game Title</th>
            <th scope="col" class="text-center">Platform(s)</th>
            <th scope="col">Release Date</th>
            <th scope="col" class="text-center">Genre(s)</th>
            {% if current_user.is_anonymous %}
            {% else %}
            <th scope="col" class="text-center">Hype Value</th>
            <th scope="col" class="text-center">My Hype Level</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for game in games | sort(attribute='game_name') %}
          <tr>
            <th scope="row"><a href="{{ url_for('game', game_id=game.id) }}">{{ game.game_name }}<a></th>
            <td align="center">
              {% for g in game.platforms.all() %}
              <span class="label label-primary">{{ g.platform_name }}</span>
              {% endfor %}
            </td>
            <td>{{ moment(game.release_date).format('L') }}</td>
            <td align="center">
              {% for g in game.genres.all() %}
              <span class="label label-default">{{ g.genre_name }}</span>
              {% endfor %}
            </td>
            {% if current_user.is_anonymous %}
            {% else %}
            <td align="center">
              {% for rate in game.ratings.filter_by(user_id=user.id) %}
              {{ rate.hype }}
              {% endfor %}
            </td>
            <td align="center">
              <!-- {{ game.ratings.filter_by(user_id=user.id).first().hype }} -->
              <select id="{{ game.id }}">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}
